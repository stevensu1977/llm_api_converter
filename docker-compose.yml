# =============================================================================
# Docker Compose for Anthropic-Bedrock Proxy
# =============================================================================
# Usage:
#   docker-compose up -d                    # Start all services
#   docker-compose up -d proxy              # Start proxy only
#   docker-compose up -d proxy-ptc          # Start PTC-enabled proxy
#   docker-compose logs -f proxy            # View logs
#   docker-compose down                     # Stop all services
# =============================================================================

version: "3.9"

services:
  # ---------------------------------------------------------------------------
  # Main Proxy Service (minimal image, no PTC)
  # ---------------------------------------------------------------------------
  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.alpine
    image: anthropic-bedrock-proxy:latest
    container_name: anthropic-proxy
    ports:
      - "8000:8000"
    environment:
      # Application
      - APP_NAME=anthropic-bedrock-proxy
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - HOST=0.0.0.0
      - PORT=8000
      # AWS
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      # DynamoDB (use local)
      - DYNAMODB_ENDPOINT_URL=http://dynamodb-local:8000
      - DYNAMODB_API_KEYS_TABLE=anthropic-proxy-api-keys
      - DYNAMODB_USAGE_TABLE=anthropic-proxy-usage
      - DYNAMODB_USAGE_STATS_TABLE=anthropic-proxy-usage-stats
      - DYNAMODB_MODEL_MAPPING_TABLE=anthropic-proxy-model-mapping
      - DYNAMODB_MODEL_PRICING_TABLE=anthropic-proxy-model-pricing
      # Auth
      - REQUIRE_API_KEY=${REQUIRE_API_KEY:-false}
      - MASTER_API_KEY=${MASTER_API_KEY:-dev-master-key}
      # Features
      - ENABLE_TOOL_USE=true
      - ENABLE_PTC=false
      - ENABLE_EXTENDED_THINKING=true
      - ENABLE_DOCUMENT_SUPPORT=true
    depends_on:
      dynamodb-local:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - proxy-network

  # ---------------------------------------------------------------------------
  # PTC-Enabled Proxy Service (with Docker access)
  # ---------------------------------------------------------------------------
  proxy-ptc:
    build:
      context: .
      dockerfile: docker/Dockerfile.ptc
    image: anthropic-bedrock-proxy-ptc:latest
    container_name: anthropic-proxy-ptc
    ports:
      - "8001:8000"
    volumes:
      # Mount Docker socket for PTC
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Application
      - APP_NAME=anthropic-bedrock-proxy
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - HOST=0.0.0.0
      - PORT=8000
      # AWS
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      # DynamoDB (use local)
      - DYNAMODB_ENDPOINT_URL=http://dynamodb-local:8000
      - DYNAMODB_API_KEYS_TABLE=anthropic-proxy-api-keys
      - DYNAMODB_USAGE_TABLE=anthropic-proxy-usage
      - DYNAMODB_USAGE_STATS_TABLE=anthropic-proxy-usage-stats
      - DYNAMODB_MODEL_MAPPING_TABLE=anthropic-proxy-model-mapping
      - DYNAMODB_MODEL_PRICING_TABLE=anthropic-proxy-model-pricing
      # Auth
      - REQUIRE_API_KEY=${REQUIRE_API_KEY:-false}
      - MASTER_API_KEY=${MASTER_API_KEY:-dev-master-key}
      # Features (PTC enabled)
      - ENABLE_TOOL_USE=true
      - ENABLE_PTC=true
      - ENABLE_EXTENDED_THINKING=true
      - ENABLE_DOCUMENT_SUPPORT=true
      # PTC Settings
      - PTC_SANDBOX_IMAGE=python:3.11-slim
      - PTC_SESSION_TIMEOUT=270
      - PTC_EXECUTION_TIMEOUT=60
      - PTC_MEMORY_LIMIT=256m
      - PTC_NETWORK_DISABLED=true
    depends_on:
      dynamodb-local:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - proxy-network
    profiles:
      - ptc

  # ---------------------------------------------------------------------------
  # DynamoDB Local
  # ---------------------------------------------------------------------------
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    ports:
      - "8002:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - proxy-network

  # ---------------------------------------------------------------------------
  # DynamoDB Table Setup (one-time init)
  # ---------------------------------------------------------------------------
  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: dynamodb-init
    depends_on:
      dynamodb-local:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Create API Keys table
        aws dynamodb create-table \
          --endpoint-url http://dynamodb-local:8000 \
          --table-name anthropic-proxy-api-keys \
          --attribute-definitions \
            AttributeName=api_key,AttributeType=S \
            AttributeName=user_id,AttributeType=S \
          --key-schema AttributeName=api_key,KeyType=HASH \
          --global-secondary-indexes '[{"IndexName":"user_id-index","KeySchema":[{"AttributeName":"user_id","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"}}]' \
          --billing-mode PAY_PER_REQUEST || true

        # Create Usage table
        aws dynamodb create-table \
          --endpoint-url http://dynamodb-local:8000 \
          --table-name anthropic-proxy-usage \
          --attribute-definitions \
            AttributeName=api_key,AttributeType=S \
            AttributeName=timestamp,AttributeType=S \
          --key-schema \
            AttributeName=api_key,KeyType=HASH \
            AttributeName=timestamp,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST || true

        # Create Usage Stats table
        aws dynamodb create-table \
          --endpoint-url http://dynamodb-local:8000 \
          --table-name anthropic-proxy-usage-stats \
          --attribute-definitions \
            AttributeName=api_key,AttributeType=S \
          --key-schema AttributeName=api_key,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || true

        # Create Model Mapping table
        aws dynamodb create-table \
          --endpoint-url http://dynamodb-local:8000 \
          --table-name anthropic-proxy-model-mapping \
          --attribute-definitions \
            AttributeName=anthropic_model_id,AttributeType=S \
          --key-schema AttributeName=anthropic_model_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || true

        # Create Model Pricing table
        aws dynamodb create-table \
          --endpoint-url http://dynamodb-local:8000 \
          --table-name anthropic-proxy-model-pricing \
          --attribute-definitions \
            AttributeName=model_id,AttributeType=S \
          --key-schema AttributeName=model_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || true

        echo "DynamoDB tables created successfully!"
    networks:
      - proxy-network
    profiles:
      - init

  # ---------------------------------------------------------------------------
  # Prometheus (metrics collection)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./deployment/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - proxy-network
    profiles:
      - monitoring

  # ---------------------------------------------------------------------------
  # Grafana (visualization)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./deployment/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - proxy-network
    profiles:
      - monitoring

networks:
  proxy-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
